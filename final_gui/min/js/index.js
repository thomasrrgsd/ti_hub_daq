window.addEventListener("load",onLoad);var cmdAck_ID,cmdPacket=new Uint8Array(6),gateway1=`ws://${window.location.hostname}:80/ws`,gateway2=`ws://${window.location.hostname}:81/ws`,timeDivOS=.05,timeDivOS2=.05;function onLoad(e){cmdPacket[0]=99;for(let e=0;e<1023;e++)x_value[e]=e;initWebSocket1(),initWebSocket2()}function initWebSocket1(){console.log("Trying to open a WebSocket connection..."),websocket1=new WebSocket(gateway1),websocket1.binaryType="arraybuffer",websocket1.onopen=onOpen1,websocket1.onclose=onClose1,websocket1.onmessage=onMessage1}function onOpen1(e){console.log("Connection opened")}function onClose1(e){console.log("Connection closed"),setTimeout(initWebSocket1,2e3)}function onMessage1(e){}function initWebSocket2(){console.log("Trying to open a WebSocket 2 connection..."),websocket2=new WebSocket(gateway2),websocket2.binaryType="arraybuffer",websocket2.onopen=onOpen2,websocket2.onclose=onClose2,websocket2.onmessage=onMessage2,websocket2.onerror=onError2}function onOpen2(e){console.log("Connection 2 opened")}function onClose2(e){console.log("Connection 2 closed"),setTimeout(initWebSocket2,2e3)}function onMessage2(e){var t=new Uint8Array(e.data);handleDataPacket(t),sendCommand(1,0),console.log(t)}function onError2(e){console.log("Websocket Error: ",e)}function sendCommandAcknowledge(){sendCommand(1,0)}function sendCommand(e,t){cmdPacket[1]=e,cmdPacket[5]=255&t,cmdPacket[4]=t>>8&255,cmdPacket[3]=t>>16&255,cmdPacket[2]=t>>24&255,websocket1.send(cmdPacket)}function handleDataPacket(e){switch(e[0]){case 1:var t=0;for(t=1;t<1024;t++)x_value[t-1]=(t*(10*timeDivOS/1023)).toPrecision(3),y_value[t-1]=e[t]*(3.3/256);pushDataOS();break;case 2:t=0;for(t=1;t<1024;t++)x_value[t-1]=(t*(10*timeDivOS2/1023)).toPrecision(3),y_value2[t-1]=e[t]*(3.3/256);pushDataOS2();break;case 3:logicChar=e[1];break;case 4:updateDMM(e[1]<<8|e[2],e[3]<<8|e[4],e[5]<<8|e[6])}}var displayDMMData=!0;function updateDMM(e,t,n){if(displayDMMData){var a=e/800,o=.01*t,l=.25*n;document.getElementById("dmm_voltage").value=a.toFixed(2)+" V",document.getElementById("dmm_current").value=o.toFixed(2)+" mA",document.getElementById("dmm_power").value=l.toFixed(2)+" mW";var i=a/o*1e3;document.getElementById("dmm_resistance").value=i.toFixed(0)+" Î©"}}function startDMM(){sendCommand(2,1),displayDMMData=!0}function stopDMM(){sendCommand(2,0),displayDMMData=!1}var chartOS=generateOSChart(),chartOS2=generateOSChart2(),voltDivCh1=1,voltDivCh2=1,voltOffCh1=0,voltOffCh2=0,displayOSData1=!0,displayOSData2=!0,y_value=[],x_value=[],y_value2=[];function generateOSChart(e,t){var n=document.getElementById("oscilloscopeChart").getContext("2d");return new Chart(n,{type:"line",data:{labels:e,datasets:[{label:"Voltage Ch 1",pointStyle:"line",data:t,steppedLine:!1,fill:!1,borderColor:"rgb(220, 53, 69)"}]},options:{plugins:{zoom:{pan:{enabled:!0,mode:"x"},zoom:{enabled:!0,mode:"x"}}},title:{display:!0,text:"Oscilloscope",fontColor:"rgb(255, 255, 255)"},animation:{duration:0},legend:{labels:{defaultFontFamily:"'Roboto', 'Franklin Gothic Medium', 'Tahoma', 'sans-serif",fontColor:"rgb(255, 255, 255)"}},color:"rgb(255, 255, 255)",scales:{yAxes:[{gridLines:{drawOnChartArea:!0,color:"rgb(255,255,255)"},ticks:{fontColor:"rgb(255, 255, 255)",beginAtZero:!0,steps:5,min:voltOffCh1,max:5*voltDivCh1+voltOffCh1,callback:function(e,t,n){return e+" V"}},scaleLabel:{display:!0,labelString:"Voltage"},type:"linear"}],xAxes:[{gridLines:{drawOnChartArea:!1},ticks:{fontColor:"rgb(255, 255, 255)",beginAtZero:!0,callback:function(e,t,n){return e+" s"}},scaleLabel:{display:!0,labelString:"Time"}}]}}})}function generateOSChart2(e,t){var n=document.getElementById("oscilloscopeChart2").getContext("2d");return new Chart(n,{type:"line",data:{labels:e,datasets:[{label:"Voltage Ch 2",pointStyle:"line",data:t,steppedLine:!1,fill:!1,borderColor:"rgb(220, 53, 69)"}]},options:{plugins:{zoom:{pan:{enabled:!0,mode:"x"},zoom:{enabled:!0,mode:"x"}}},title:{display:!0,text:"Oscilloscope",fontColor:"rgb(255, 255, 255)"},animation:{duration:0},legend:{labels:{defaultFontFamily:"'Roboto', 'Franklin Gothic Medium', 'Tahoma', 'sans-serif",fontColor:"rgb(255, 255, 255)"}},color:"rgb(255, 255, 255)",scales:{yAxes:[{gridLines:{drawOnChartArea:!0,color:"rgb(255,255,255)"},ticks:{fontColor:"rgb(255, 255, 255)",beginAtZero:!0,steps:5,min:voltOffCh2,max:5*voltDivCh2+voltOffCh2,callback:function(e,t,n){return e+" V"}},scaleLabel:{display:!0,labelString:"Voltage"},type:"linear"}],xAxes:[{gridLines:{drawOnChartArea:!1},ticks:{fontColor:"rgb(255, 255, 255)",beginAtZero:!0,callback:function(e,t,n){return e+" s"}},scaleLabel:{display:!0,labelString:"Time"}}]}}})}function pushDataOS(){chartOS.destroy(),chartOS=generateOSChart(x_value,y_value)}function pushDataOS2(){chartOS2.destroy(),chartOS2=generateOSChart2(x_value,y_value2)}function updateOSChart(){}function updateVoltDivCh1(){voltDivCh1=parseFloat(document.getElementById("voltDivCh1").value),isNaN(voltDivCh1)||("mV"==document.getElementById("voltDivUnitCh1").value?(document.getElementById("voltDivCh1").value=voltDivCh1,voltDivCh1/=1e3):document.getElementById("voltDivCh1").value=voltDivCh1)}function updateVoltOffCh1(){voltOffCh1=parseFloat(document.getElementById("voltOffCh1").value),isNaN(voltOffCh1)||("mV"==document.getElementById("voltOffUnitCh1").value?(document.getElementById("voltOffCh1").value=voltOffCh1,voltOffCh1/=1e3):document.getElementById("voltOffCh1").value=voltOffCh1)}function updateVoltUnitCh1(e){if(e){var t=parseFloat(document.getElementById("voltDivCh1").value);if(isNaN(t))return;"mV"==document.getElementById("voltDivUnitCh1").value?document.getElementById("voltDivCh1").value=1e3*t:document.getElementById("voltDivCh1").value=t/1e3}else{var n=parseFloat(document.getElementById("voltOffCh1").value);if(isNaN(n))return;"mV"==document.getElementById("voltOffUnitCh1").value?document.getElementById("voltOffCh1").value=1e3*n:document.getElementById("voltOffCh1").value=n/1e3}}function updateVoltDivCh2(){voltDivCh2=parseFloat(document.getElementById("voltDivCh2").value),isNaN(voltDivCh2)||("mV"==document.getElementById("voltUnitCh2").value?(document.getElementById("voltDivCh2").value=voltDivCh2,voltDivCh2/=1e3):document.getElementById("voltDivCh2").value=voltDivCh2)}function updateVoltOffCh2(){voltOffCh2=parseFloat(document.getElementById("voltOffCh2").value),isNaN(voltOffCh2)||("mV"==document.getElementById("voltOffUnitCh2").value?(document.getElementById("voltOffCh2").value=voltOffCh2,voltOffCh2/=1e3):document.getElementById("voltOffCh2").value=voltOffCh2)}function updateVoltUnitCh2(e){if(e){var t=parseFloat(document.getElementById("voltDivCh2").value);if(isNaN(t))return;"mV"==document.getElementById("voltDivUnitCh2").value?document.getElementById("voltDivCh2").value=1e3*t:document.getElementById("voltDivCh2").value=t/1e3}else{var n=parseFloat(document.getElementById("voltOffCh2").value);if(isNaN(n))return;"mV"==document.getElementById("voltOffUnitCh2").value?document.getElementById("voltOffCh2").value=1e3*n:document.getElementById("voltOffCh2").value=n/1e3}}function updateTimeDivOS(){timeDivOS=parseFloat(document.getElementById("timeDivOS").value),isNaN(timeDivOS)||("mSec"==document.getElementById("timeUnitOS").value?(document.getElementById("timeDivOS").value=timeDivOS,timeDivOS/=1e3):"uSec"==document.getElementById("timeUnitOS").value?(document.getElementById("timeDivOS").value=timeDivOS,timeDivOS/=1e6):document.getElementById("timeDivOS").value=timeDivOS,sendCommand(6,Math.round(10*timeDivOS/1023*6e6)))}function updateTimeUnitOS(){tempDivOS=parseFloat(document.getElementById("timeDivOS").value),isNaN(tempDivOS)||("mSec"==document.getElementById("timeUnitOS").value?document.getElementById("timeDivOS").value=1e3*tempDivOS:"uSec"==document.getElementById("timeUnitOS").value?document.getElementById("timeDivOS").value=1e6*tempDivOS:document.getElementById("timeDivOS").value=tempDivOS/1e3)}function updateTimeDivOS2(){timeDivOS2=parseFloat(document.getElementById("timeDivOS2").value),isNaN(timeDivOS2)||("mSec"==document.getElementById("timeUnitOS2").value?(document.getElementById("timeDivOS2").value=timeDivOS,timeDivOS2/=1e3):"uSec"==document.getElementById("timeUnitOS2").value?(document.getElementById("timeDivOS2").value=timeDivOS2,timeDivOS2/=1e6):document.getElementById("timeDivOS2").value=timeDivOS2,sendCommand(7,Math.round(10*timeDivOS2/1023*6e6)))}function updateTimeUnitOS2(){tempDivOS2=parseFloat(document.getElementById("timeDivOS2").value),isNaN(tempDivOS2)||("mSec"==document.getElementById("timeUnitOS2").value?document.getElementById("timeDivOS2").value=1e3*tempDivOS2:"uSec"==document.getElementById("timeUnitOS2").value?document.getElementById("timeDivOS2").value=1e6*tempDivOS2:document.getElementById("timeDivOS2").value=tempDivOS2/1e3)}function startOS1(){sendCommand(3,1),sendCommand(1,0),displayOSData1=!0}function stopOS1(){sendCommand(3,0),displayOSData1=!1}function startOS2(){sendCommand(4,1),displayOSData2=!0}function stopOS2(){sendCommand(4,0),displayOSData2=!1}var chartFG=generateFGChart(),channelFG=0,freqFG=[5,5,5,5],ampFG=[1,1,1,1],dacfreqFG=1024,typeFG=[0,0,0,0],biasFG=[1,1,1,1];function generateFGChart(){return new Chart(document.getElementById("idealChart").getContext("2d"),{type:"line",data:{datasets:[{pointStyle:"line",label:"Ideal voltage",data:[],steppedLine:!1,fill:!1,borderColor:"rgb(220, 53, 69)"}]},options:{plugins:{zoom:{pan:{enabled:!0,mode:"x"},zoom:{enabled:!0,mode:"x"}}},title:{display:!0,text:"Waveform",fontColor:"rgb(255, 255, 255)"},legend:{display:!1,labels:{defaultFontFamily:"'Roboto', 'Franklin Gothic Medium', 'Tahoma', 'sans-serif",fontColor:"rgb(255, 255, 255)"}},color:"rgb(255, 255, 255)",scales:{yAxes:[{gridLines:{drawOnChartArea:!0,color:"rgb(255,255,255)"},ticks:{fontColor:"rgb(255, 255, 255)",beginAtZero:!0,callback:function(e,t,n){return e+" V"}},scaleLabel:{display:!0,labelString:"Voltage"},type:"linear"}],xAxes:[{ticks:{fontColor:"rgb(255, 255, 255)",beginAtZero:!0,callback:function(e,t,n){return e+" s"}},scaleLabel:{display:!0,labelString:"Time"},type:"linear"}]}}})}function trimNum(e){return Math.round(e*10**7)/10**7}function setIdealChart(e,t,n,a,o){var l=1e3,d=[],c=[],r=1/e/l;switch(a){case 0:for(c.push(o-t/2),d.push(0),i=1;i<999;i++)s=i*r,i<500?c.push(o+t/2):c.push(o-t/2),d.push(s);c.push(o+t/2),d.push(999*r);break;case 1:for(i=0;i<l;i++)s=i*r,c.push(t/2*Math.sin(2*Math.PI*e*s)+o),d.push(s);break;case 2:var m=t/1e3;for(i=0;i<999;i++)s=i*r,c.push(i*m+o-t/2),d.push(s);c.push(o-t/2),d.push(999*r);break;case 3:var s;for(i=0;i<l;i++)s=i*r,c.push(o),d.push(s)}for(chartFG.data.datasets[0].data=[],i=0;i<l;i++)chartFG.data.datasets[0].data.push({x:d[i],y:c[i]});chartFG.update()}function resetZoom(){chartFG.resetZoom()}function updateFreqFG(){freqFG[channelFG]=document.getElementById("freqFG").value,freqFG[channelFG]=freqFG[channelFG]<=0?.01:freqFG[channelFG],document.getElementById("freq-input").value=freqFG[channelFG],setIdealChart(freqFG[channelFG],ampFG[channelFG],dacfreqFG,typeFG[channelFG],biasFG[channelFG]),console.log(Math.round(1/freqFG[channelFG]*(1/128)*75e4)),sendCommand(17+channelFG,Math.round(1/freqFG[channelFG]*(1/128)*75e4))}function updateAmpFG(){ampFG[channelFG]=parseFloat(document.getElementById("ampFG").value),document.getElementById("amplitude-input-fg").value=ampFG[channelFG],setIdealChart(freqFG[channelFG],ampFG[channelFG],dacfreqFG,typeFG[channelFG],biasFG[channelFG]);var e=parseInt(ampFG[channelFG]*(65535/3.3));sendCommand(13+channelFG,e)}function updateTypeFG(){typeFG[channelFG]=document.getElementById("typeFG").selectedIndex,setIdealChart(freqFG[channelFG],ampFG[channelFG],dacfreqFG,typeFG[channelFG],biasFG[channelFG]),sendCommand(9+channelFG,typeFG[channelFG])}function updateBiasFG(){biasFG[channelFG]=parseFloat(document.getElementById("biasFG").value),document.getElementById("bias-input").value=biasFG[channelFG],setIdealChart(freqFG[channelFG],ampFG[channelFG],dacfreqFG,typeFG[channelFG],biasFG[channelFG]);var e=parseInt(biasFG[channelFG]*(65535/3.3));sendCommand(21+channelFG,e)}function changeChFG(){channelFG=document.getElementById("chFG").selectedIndex,document.getElementById("typeFG").selectedIndex=typeFG[channelFG],document.getElementById("freq-input").value=freqFG[channelFG],document.getElementById("amplitude-input-fg").value=ampFG[channelFG],document.getElementById("bias-input").value=biasFG[channelFG],setIdealChart(freqFG[channelFG],ampFG[channelFG],dacfreqFG,typeFG[channelFG],biasFG[channelFG])}function startFG(){switch(channelFG){case 0:sendCommand(5,16);break;case 1:sendCommand(5,18);break;case 2:sendCommand(5,20);break;case 3:sendCommand(5,22)}}function stopFG(){switch(channelFG){case 0:sendCommand(5,48);break;case 1:sendCommand(5,50);break;case 2:sendCommand(5,52);break;case 3:sendCommand(5,54)}}$(document).ready((function(){setIdealChart(freqFG[channelFG],ampFG[channelFG],dacfreqFG,typeFG[channelFG],biasFG[channelFG])}));var chartLA=generateLAChart(),activeChannels=0,logicChar=0,perio_count=0,intervalIDLA=0;function hideChannel(e){mask=1<<e;var t=document.getElementById("channelToggle"+e);activeChannels&mask?(activeChannels&=~mask,t.style.background="#c00",t.style.color="white"):(activeChannels|=mask,t.style.background="white",t.style.color="#c00")}function pauseAll(){var e=document.getElementById("pauseLA");"Paused"==e.textContent?(e.textContent="Running",e.style.background="white",e.style.color="#c00",intervalIDLA=setInterval(periodicUpdateLA,10)):"Running"==e.textContent&&(e.textContent="Paused",e.style.background="#c00",e.style.color="white",clearInterval(intervalIDLA))}function generateLAChart(){var e=document.getElementById("channelChart").getContext("2d");return new Chart(e,{type:"line",data:{datasets:[{label:"Channel 1",pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"},{label:"Channel 2",pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"},{label:"Channel 3",pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"},{label:"Channel 4",pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"},{label:"Channel 5",pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"},{pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"},{label:"Channel 7",pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"},{label:"Channel 8",pointStyle:"line",data:[],steppedLine:!0,fill:!1,borderColor:"rgb(220, 53, 69)"}]},options:{plugins:{zoom:{pan:{enabled:!0,mode:"x"},zoom:{enabled:!0,mode:"x"}}},title:{display:!0,text:"Logic Analyzer",fontColor:"rgb(255, 255, 255)"},animation:{duration:0},legend:{display:!1,labels:{defaultFontFamily:"'Roboto', 'Franklin Gothic Medium', 'Tahoma', 'sans-serif",fontColor:"rgb(255, 255, 255)"}},color:"rgb(255, 255, 255)",scales:{yAxes:[{gridLines:{drawOnChartArea:!0,color:"rgb(255,255,255)"},ticks:{fontColor:"rgb(255, 255, 255)",beginAtZero:!1,min:.9,max:9,steps:7,callback:function(e,t,n){if(e>=1&&e<9)return e}},scaleLabel:{display:!0,labelString:"Channel"},type:"linear"}],xAxes:[{gridLines:{drawOnChartArea:!1},ticks:{beginAtZero:!0,max:500,fontColor:"rgb(255, 255, 255)",callback:function(e,t,n){}},scaleLabel:{display:!0,labelString:"Time"}}]}}})}function periodicUpdateLA(){var e=1,t=0;for(perio_count>500&&(perio_count=0),t=0;t<8;t++)chartLA.data.datasets[t].data[perio_count]=logicChar&e?1.7+t:1+t,activeChannels&e||(chartLA.data.datasets[t].data[perio_count]=NaN),e<<=1;chartLA.data.labels[perio_count]=perio_count,chartLA.update("quiet"),perio_count++}